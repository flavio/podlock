name: "Bump Chart Version and Image Tags"

scms:
  default:
    kind: github
    spec:
      user: "github-actions[bot]"
      email: "github-actions[bot]@users.noreply.github.com"
      owner: "{{ requiredEnv .github.owner }}"
      repository: "{{ requiredEnv .github.repository }}"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.actor }}"
      branch: "main"
      commitusingapi: true

sources:
  releaseTag:
    name: "Get latest release tag"
    kind: githubrelease
    spec:
      owner: "flavio"
      repository: "podlock"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.actor }}"
      versionfilter:
        kind: regex
        pattern: "^v\\d+\\.\\d+\\.\\d+$"

  nextChartVersion:
    name: "Calculate next chart version (minor bump)"
    kind: yaml
    transformers:
      - semverinc: minor
    spec:
      file: "charts/podlock/Chart.yaml"
      key: "$.version"

conditions:
  controllerImage:
    name: "Ensure controller image exists"
    kind: dockerimage
    spec:
      image: "ghcr.io/flavio/podlock/controller"
      tag: '{{ source "releaseTag" }}'
    sourceid: releaseTag

  nriImage:
    name: "Ensure nri image exists"
    kind: dockerimage
    spec:
      image: "ghcr.io/flavio/podlock/nri"
      tag: '{{ source "releaseTag" }}'
    sourceid: releaseTag

targets:
  updateControllerImageTag:
    name: "Update controller image tag in values.yaml"
    kind: yaml
    spec:
      file: "charts/podlock/values.yaml"
      key: "$.controller.image.tag"
    sourceid: releaseTag
    scmid: default

  updateNriImageTag:
    name: "Update nri image tag in values.yaml"
    kind: yaml
    spec:
      file: "charts/podlock/values.yaml"
      key: "$.nri.image.tag"
    sourceid: releaseTag
    scmid: default

  updateAppVersion:
    name: "Update appVersion in Chart.yaml"
    kind: yaml
    spec:
      file: "charts/podlock/Chart.yaml"
      key: "$.appVersion"
    sourceid: releaseTag
    scmid: default

  updateChartVersion:
    name: "Bump chart version in Chart.yaml"
    kind: yaml
    spec:
      file: "charts/podlock/Chart.yaml"
      key: "$.version"
    sourceid: nextChartVersion
    scmid: default

actions:
  default:
    kind: github/pullrequest
    scmid: default
    spec:
      title: 'chore: bump chart version to {{ source "nextChartVersion" }}'
      description: |
        Automated update of Podlock Helm chart.

        - Bumped chart version to {{ source "nextChartVersion" }}
        - Updated appVersion to {{ source "releaseTag" }}
        - Updated controller/nri images to {{ source "releaseTag" }}
      labels:
        - "kind/chore"
      automerge: false
      mergemethod: squash
      parent: true
      usetitleforautomerge: true
